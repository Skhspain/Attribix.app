// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"   // <- must be postgresql on Fly
  url      = env("DATABASE_URL")
}

/* Shopify Session (PRISMA STORAGE) */
model Session {
  id            String   @id
  shop          String
  state         String
  isOnline      Boolean  @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String?        // <-- must be optional for pre-token sessions
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean  @default(false)
  locale        String?
  collaborator  Boolean? @default(false)
  emailVerified Boolean? @default(false)

  @@index([shop])
  @@index([state])
}

/* Basic App Models (yours, unchanged except formatting) */
model TrackedItem {
  id        Int       @id @default(autoincrement())
  name      String
  status    String    @default("new")
  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt
}

model TrackedEvent {
  id          Int              @id @default(autoincrement())
  eventName   String
  url         String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  value       Float?
  currency    String?
  email       String?
  phone       String?
  ip          String?
  userAgent   String?
  sessionId   String?
  orderId     String?
  shop        String?
  createdAt   DateTime         @default(now())
  products    TrackedProduct[]

  // Optional enrichments
  path        String?
  referrer    String?
  gclid       String?
  fbclid      String?
  ttclid      String?
  msclkid     String?

  session     WebSession?      @relation(fields: [sessionId], references: [id])

  @@index([createdAt])
  @@index([eventName])
  @@index([utmSource, utmMedium, utmCampaign])
}

model TrackedProduct {
  id             Int           @id @default(autoincrement())
  trackedEvent   TrackedEvent  @relation(fields: [trackedEventId], references: [id], onDelete: Cascade)
  trackedEventId Int
  productId      String?
  productName    String
  quantity       Int
}

model TrackingSettings {
  shop    String  @id
  pixelId String
  enabled Boolean @default(false)
}

/* Web Sessions */
model WebSession {
  id            String    @id @default(cuid())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  anonId        String?
  clientId      String?
  ipHash        String?
  userAgent     String?

  firstTouchAt  DateTime?
  lastTouchAt   DateTime?

  utmSource     String?
  utmMedium     String?
  utmCampaign   String?
  utmContent    String?
  utmTerm       String?
  gclid         String?
  fbclid        String?
  ttclid        String?
  msclkid       String?

  consentAdvertising Boolean? @default(false)
  consentMarketing   Boolean? @default(false)

  events       TrackedEvent[]
  purchases    Purchase[]

  @@index([createdAt])
  @@index([utmSource, utmMedium, utmCampaign])
}

/* Purchases */
model Purchase {
  id                 String      @id @default(cuid())
  createdAt          DateTime    @default(now())
  shopifyOrderId     String      @unique
  totalValue         Float
  currency           String
  customerEmailHash  String?

  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  gclid       String?
  fbclid      String?

  items       PurchaseItem[]

  sessionId   String?
  session     WebSession? @relation(fields: [sessionId], references: [id])

  @@index([createdAt])
  @@index([utmSource, utmMedium, utmCampaign])
}

model PurchaseItem {
  id           String    @id @default(cuid())
  purchaseId   String
  purchase     Purchase  @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  productId    String
  productName  String
  quantity     Int
  price        Float
  category     String?
  brand        String?

  @@index([productId])
}

/* Ad spend (daily) */
model AdSpendDaily {
  id        String   @id @default(cuid())
  date      DateTime
  platform  String
  campaign  String?
  adset     String?
  ad        String?
  spend     Float    @default(0)

  @@index([date])
  @@index([platform, date])
}
